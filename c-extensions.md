---
layout: default
title: C Extensions
previous: /run-your-own-gem-server
next: /resources
---

This guide explains how to make a C extension and package it as a gem.

To get started, we'll add a C method to the `hola` gem from the
[make your own gem](/make-your-own-gem) guide. Then we'll discuss some general
issues and give some pointers on where to go for information.

<a id="tutorial"> </a>
A `hola` C extension
--------------------

At the end of the [make your own gem](/make-your-own-gem) guide, `hola` looked
like this:

    % tree
    .
    |-- bin
    |   `-- hola
    |-- hola.gemspec
    |-- lib
    |   |-- hola
    |   |   `-- translator.rb
    |   `-- hola.rb
    |-- Rakefile
    `-- test
        `-- test_hola.rb

Now we'll add one more folder, `ext`, that contains two files:

    % tree ext
    ext
    |-- extconf.rb
    `-- hola_ext.c

`extconf.rb` is a script that describes how to build the extension:

    % cat ext/extconf.rb
    require 'mkmf'

    create_makefile('hola_ext')

When you install a gem that contains the code for a C extension (and has the
appropriate settings in the `gemspec`):

1. Rubygems calls its `extconf.rb`.
2. `extconf.rb` creates a [Makefile](http://en.wikipedia.org/wiki/Makefile)
using `mkmf`, which is part of the ruby standard library.
3. Rubygems runs `make` to build the extension. The result is a [shared
object](http://en.wikipedia.org/wiki/Shared_object) (DLL on Windows).
4. Rubygems installs the shared object into the gem's `lib` folder.

In this case, the shared object is `hola_ext.so` (on Linux), because the
argument to `create_makefile` is `hola_ext`. In general, `<gem name>_ext` is a
good name to use for the extension (see below).

`hola_ext.c` contains the C source for the extension:

    % cat ext/hola_ext.c    
    #include <ruby.h>
    
    /* our new native method; it just returns the string "bonjour!" */
    static VALUE hola_bonjour(VALUE self) {
      return rb_str_new2("bonjour!");
    }
    
    /* this is called by ruby when loading the extension */
    void Init_hola_ext(void) {
      /* assume we haven't yet defined class Hola */
      VALUE klass = rb_define_class("Hola");

      /* the hola_bonjour function can be called from ruby as "Hola.bonjour" */
      rb_define_singleton_method(klass, "bonjour", hola_bonjour, 0);
    }

Some references for ruby's C API are given at the end of guide. Two common
features of this file are

1. It includes `ruby.h`. The Makefile generated by `mkmf` makes sure that the
compiler knows where this header file is.
2. It contains an `Init_<gem name>_ext` function; this is used to map ruby
classes, modules and methods to C functions.

TODO more
