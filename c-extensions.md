---
layout: default
title: C Extensions
previous: /run-your-own-gem-server
next: /resources
---

This guide explains how to make a C extension and package it as a gem.

To get started, we'll add a C method to the `hola` gem from the
[make your own gem](/make-your-own-gem) guide. Then we'll discuss some general
issues and give some pointers on where to go for information.

<a id="tutorial"> </a>
Tutorial: Adding a C extension to `hola` 
========================================

At the end of the [make your own gem](/make-your-own-gem) guide, `hola` looked
like this:

    % tree
    .
    |-- bin
    |   `-- hola
    |-- hola.gemspec
    |-- lib
    |   |-- hola
    |   |   `-- translator.rb
    |   `-- hola.rb
    |-- Rakefile
    `-- test
        `-- test_hola.rb

To add in the C extension, we'll go through a few steps.

<a id="tutorial-ext"> </a>
Create an `ext` folder
----------------------

Just as we put the ruby source files in the `lib/hola` folder, we put the C
extension source files in `ext/hola`. This folder contains two files:

    % tree ext
    ext
    `-- hola
        |-- extconf.rb
        `-- hola.c

`extconf.rb` tells rubygems how to build the extension. For `hola`, it reads:

    % cat ext/hola/extconf.rb 
    require 'mkmf'

    create_makefile('hola/hola')

`mkmf` is part of ruby's standard library; it automates the process of creating
a [Makefile](http://en.wikipedia.org/wiki/Makefile) which, in turn, automates
the process of building the extension. So, when rubygems installs a gem, it
first runs the gem's `extconf.rb`, and then it runs `make` on the resulting
`Makefile`.

The output from `make` is a [dynamically linked
library](http://en.wikipedia.org/wiki/Shared_object). In this case, the
output is a file called `hola/hola.so`, on Linux, where `.so` stands for 'shared
object'. The extension is platform-dependent; it would be `.dll` on Windows, or
`.dylib` on Mac OS X. The name is what we pass to `create_makefile`.

In general, a good convention for the name is `<gem name>/<gem name>`. While it
is annoying to have to type the gem's name so many times, it will be seen that
this is important for avoiding naming conflicts.

The content of the extension is in `hola.c`, which reads:

    % cat ext/hola/hola.c 
    #include <ruby.h>

    /* our new native method; it just returns the string "bonjour!" */
    static VALUE hola_bonjour(VALUE self) {
      return rb_str_new2("bonjour!");
    }

    /* this is called by ruby when loading the extension */
    void Init_hola(void) {
      /* assume we haven't yet defined class Hola */
      VALUE klass = rb_define_class("Hola", rb_cObject);

      /* the hola_bonjour function can be called from ruby as "Hola.bonjour" */
      rb_define_singleton_method(klass, "bonjour", hola_bonjour, 0);
    }

`ruby.h` provides declarations for ruby's C API. The `Makefile` generated by
`mkmf` ensures that the compiler knows where this header file is. Some
references for ruby's C API are given at the end of this guide.

Again, the name of the file is important, because it matches the second `hola`
in the `hola/hola` that we passed to `create_makefile` in `extconf.rb`.
Similarly, the name of the `Init_hola` function is important, because ruby looks
for a function with this name when it loads `hola/hola.so`. It is best to adhere
to these naming conventions.

<a id="tutorial-gemspec"> </a>
Modify the `gemspec`
--------------------

To tell rubygems that a gem contains a C extension, we have to tell it about
`extconf.rb`, and we have to include the C source files in the `files` list.

    % cat hola.gemspec 
    Gem::Specification.new do |s|
      ... (other stuff) ...

      s.files = Dir.glob('lib/**/*.rb') + Dir.glob('ext/**/*{.c,.h}')
      s.extensions = ['ext/hola/extconf.rb']
      s.executables = ['hola']

      ... (other stuff) ...
    end

Here we're computing the `files` list dynamically; when we run `gem build`
below, it will include all matching files in the gem. Rubygems automatically
adds the extensions and executables to the files list, so you don't have to list
them under `files`. 

<a id="tutorial-load"> </a>
Load the extension
--------------------

The final step is to load the shared object when the gem is loaded. To do this,
we simply require `hola/hola` at the top of `lib/hola.rb`:

    % cat lib/hola.rb
    require 'hola/hola'

    class Hola
    ... (rest of file unchanged) ...

To see why this works, it helps to build and install the gem, which we can now
do:

    % gem build hola.gemspec 
    Successfully built RubyGem
    Name: hola
    Version: 0.0.1
    File: hola-0.0.1.gem
    % gem install hola-0.0.1.gem 
    Building native extensions.  This could take a while...
    Successfully installed hola-0.0.1
    1 gem installed

I'm running this on [rvm](http://beginrescueend.com/), the ruby version manager,
under Linux, so it installs the gem to a folder under `~/.rvm`. The resulting
files are shown below:

    % tree ~/.rvm/gems/ruby-1.8.7-p352/gems/hola-0.0.1/
    /home/john/.rvm/gems/ruby-1.8.7-p352/gems/hola-0.0.1/
    |-- bin
    |   `-- hola
    |-- ext
    |   `-- hola
    |       |-- extconf.rb
    |       |-- hola.c
    |       |-- hola.o
    |       |-- hola.so
    |       `-- Makefile
    |-- lib
    |   |-- hola
    |   |   |-- hola.so
    |   |   `-- translator.rb
    |   `-- hola.rb
    `-- test
        `-- test_hola.rb

There are two copies of `hola.so`: one in `ext/hola` and the other in
`lib/hola`. After rubygems builds the extension, it copies `hola/hola.so` from
`ext` to `lib`. The gem's `lib` folder is on the `$LOAD_PATH`, so

    require 'hola/hola'

loads `lib/hola/hola.so`. The reason that we don't specify the file extension in
the `require` is that it is platform-dependent, and ruby figures it out itself.

We can now use the gem as before:

    % irb -rubygems
    ruby-1.8.7-p352 :001 > require 'hola'
    => true 
    ruby-1.8.7-p352 :002 > Hola.bonjour
    => "bonjour!" 

The string `"bonjour!"` came from our C extension. Hooray! 

<a id="tutorial-rakefile"> </a>
Add helpful tasks to the `Rakefile`
-----------------------------------

Building and install the gem every time you make a change quickly gets tedious.
To speed things up, it helps to add some extra tasks to your Rakefile that
automate the build process. The following should work on *nix, but it would need
some tweaking to run on Windows.

    require 'rake/testtask'
    require 'rake/clean'

    NAME = 'hola'

    # rule to build the extension: this says that the extension should be
    # rebuilt after any change to to the source files in ext
    file "lib/#{NAME}/#{NAME}.so" => Dir.glob("ext/#{NAME}/*{.rb,.c}") do
      Dir.chdir("ext/#{NAME}") do
        # this does essentially the same thing as rubygems does
        ruby "extconf.rb"
        sh "make"
      end
      cp "ext/#{NAME}/#{NAME}.so", "lib/#{NAME}"
    end

    # make the :test task depend on the shared object, so it will be built
    # automatically before running the tests
    task :test => "lib/#{NAME}/#{NAME}.so"

    # use 'rake clean' and 'rake clobber' to easily delete generated files
    CLEAN.include('ext/**/*{.o,.log,.so}')
    CLEAN.include('ext/**/Makefile')
    CLOBBER.include('lib/**/*.so')

    # the same as before
    Rake::TestTask.new do |t|
      t.libs << 'test'
    end

    desc "Run tests"
    task :default => :test

Now typing `rake` will run the tests after building (or rebuilding) the
extension, as necessary:
    
    % rake
    (in /home/john/rubygems_hola)
    /home/john/.rvm/rubies/ruby-1.8.7-p352/bin/ruby extconf.rb
    creating Makefile
    make
    gcc -I. -I/home/john/.rvm/rubies/ruby-1.8.7-p352/lib/ruby/1.8/i686-linux -I/home/john/.rvm/rubies/ruby-1.8.7-p352/lib/ruby/1.8/i686-linux -I. -D_FILE_OFFSET_BITS=64  -fPIC -g -O2  -fPIC   -c hola.c
    gcc -shared -o hola.so hola.o -L. -L/home/john/.rvm/rubies/ruby-1.8.7-p352/lib -Wl,-R/home/john/.rvm/rubies/ruby-1.8.7-p352/lib -L.  -rdynamic -Wl,-export-dynamic    -Wl,-R -Wl,/home/john/.rvm/rubies/ruby-1.8.7-p352/lib -L/home/john/.rvm/rubies/ruby-1.8.7-p352/lib -lruby  -lrt -ldl -lcrypt -lm   -lc
    cp ext/hola/hola.so lib/hola
    Loaded suite /home/john/.rvm/gems/ruby-1.8.7-p352/gems/rake-0.8.7/lib/rake/rake_test_loader
    Started
    ....
    Finished in 0.00182 seconds.

    4 tests, 4 assertions, 0 failures, 0 errors

If the C source and `extconf.rb` build script have not changed, then running
`rake` a second time runs only the test suite.

Some other Guidelines
=====================

Extension Naming
----------------

Because rubygems copies the shared object (`.so`) file to the gem's `lib`
directory when it is installed, loading the gem puts the 


Portability
-----------

This section needs help! [Please contribute.](http://github.com/rubygems/guides)

Next Steps 
==========

There are several other tutorials, including:
* [a 5 minute tutorial on RubyInsider](http://www.rubyinside.com/how-to-create-a-ruby-extension-in-c-in-under-5-minutes-100.html)
* [a longer tutorial](http://tenderlovemaking.com/2009/12/18/writing-ruby-c-extensions-part-1/)

The main references for ruby's C API are:
* [a chapter in the Pickaxe book](http://www.ruby-doc.org/docs/ProgrammingRuby/html/ext_ruby.html)
* [the README.EXT file](https://github.com/ruby/ruby/blob/trunk/README.EXT)

